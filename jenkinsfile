
pipeline {
    agent {
        label "power9"
    }
    environment {
        ICR_REGISTRY = 'icr.io'
        ICR_NAMESPACE = 'ai-services-cicd'
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'git branch'
            }
        }
        stage('Build and Archive Go Binary') {
            when {
                changeset "ai-services/**/*"
            }
            steps {
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                    sh '''
                    podman run --name ai-services-build-env \
                    -v $WORKSPACE:/workspace:z \
                    -w /workspace \
                    --replace \
                    registry.access.redhat.com/ubi9/go-toolset:1.24 \
                    /bin/bash -c 'cd ai-services && make build BUILDFLAGS=-buildvcs=false BIN=/tmp'
                    '''
                    sh "mkdir -p bin"
                    sh "podman cp ai-services-build-env:/tmp/ai-services ./bin"
                }
            }
            post {
                success {
                    echo 'Go binary built successfully.'
                    archiveArtifacts artifacts: 'bin/ai-services', fingerprint: true
                }
                always {
                    sh 'podman rm -f ai-services-build-env || true'
                }
            }
        }
        stage('Build and push etcd image') {
            when {
                changeset "images/etcd/**/*"
            }
            steps {
                script {
                    pushImage('etcd')
                }
            }
        }
        stage('Build and push minio image') {
            when {
                changeset "images/minio/**/*"
            }
            steps {
                script {
                    pushImage('minio')
                }
            }
        }
        stage('Build and push rag-base image') {
            when {
                changeset "images/rag-base/**/*"
            }
            steps {
                script {
                    pushImage('rag-base')
                }
            }
        }
        stage('Build and push tools image') {
            when {
                changeset "images/tools/**/*"
            }
            steps {
                script {
                    pushImage('tools')
                }
            }
        }
    }
}
def pushImage(imageName) {
    withCredentials([
        usernamePassword(
            credentialsId: 'ai-services-icr-creds',
            passwordVariable: 'ICR_API_KEY',
            usernameVariable: 'ICR_USERNAME'
        )]) {
            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                dir("images/${imageName}") {
                sh "echo 'Building ${imageName} container image.'"
                sh "make build REGISTRY=${ICR_REGISTRY}/${ICR_NAMESPACE}"
                sh "echo 'Pushing ${imageName} container image.'"
                sh "make push REGISTRY=${ICR_REGISTRY}/${ICR_NAMESPACE} REGISTRY_USER=${ICR_USERNAME} REGISTRY_PASSWORD=${ICR_API_KEY}"
            }
        }
    }
}
